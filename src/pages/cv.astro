---
import BaseLayout from '@components/layout/BaseLayout.astro';
import Timeline from '@components/ui/Timeline.astro';
import { getConfig } from '@lib/config';
import fs from 'node:fs';
import path from 'node:path';
import yaml from 'yaml';

const config = getConfig();
if (!config.pages.cv) return Astro.redirect('/404');

let cvData: any = { education: [], experience: [], skills: [], awards: [], service: [] };
try {
  const cvPath = path.resolve(process.cwd(), 'src/content/cv/cv.yml');
  cvData = yaml.parse(fs.readFileSync(cvPath, 'utf-8'));
} catch {}
---

<BaseLayout title="CV" description="Curriculum Vitae">
  <div class="animate-on-scroll">
    <div class="flex items-center justify-between mb-8">
      <div class="page-header">
        <h1 class="text-3xl font-bold">Curriculum Vitae</h1>
      </div>
      {!config.cv?.hide_pdf_download && (
        <a
          href="/files/cv.pdf"
          class="inline-flex items-center gap-2 px-4 py-2 rounded-xl text-sm font-medium hover:opacity-90 transition-opacity"
          style="background-color: var(--color-accent); color: #ffffff;"
          download
        >
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
          Download PDF
        </a>
      )}
    </div>
  </div>

  <!-- Skills -->
  {cvData.skills?.length > 0 && (
    <section class="mb-12 animate-on-scroll">
      <h2 class="text-xl font-semibold mb-6 flex items-center gap-2">
        <svg class="w-5 h-5 text-[var(--color-accent)]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/></svg>
        Skills
      </h2>
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
        {cvData.skills.map((skill: any) => (
          <div class="p-4 rounded-xl bg-[var(--color-card-bg)] border border-[var(--color-border)]">
            <h3 class="font-medium text-sm text-[var(--color-accent)] mb-2">{skill.category}</h3>
            <div class="flex flex-wrap gap-1.5">
              {skill.items.map((item: string) => (
                <span class="px-2 py-0.5 rounded-full text-xs bg-[var(--color-border)]/50 text-[var(--color-text-secondary)]">{item}</span>
              ))}
            </div>
          </div>
        ))}
      </div>
    </section>
  )}

  <!-- Education -->
  {cvData.education?.length > 0 && (
    <section class="mb-12 animate-on-scroll">
      <h2 class="text-xl font-semibold mb-6 flex items-center gap-2">
        <svg class="w-5 h-5 text-[var(--color-accent)]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 14l9-5-9-5-9 5 9 5z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 14l6.16-3.422a12.083 12.083 0 01.665 6.479A11.952 11.952 0 0012 20.055a11.952 11.952 0 00-6.824-2.998 12.078 12.078 0 01.665-6.479L12 14z"/></svg>
        Education
      </h2>
      <Timeline items={cvData.education.map((e: any) => ({
        title: e.degree,
        subtitle: e.institution,
        date: e.year,
        description: e.description,
      }))} />
    </section>
  )}

  <!-- Experience -->
  {cvData.experience?.length > 0 && (
    <section class="mb-12 animate-on-scroll">
      <h2 class="text-xl font-semibold mb-6 flex items-center gap-2">
        <svg class="w-5 h-5 text-[var(--color-accent)]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
        Experience
      </h2>
      <Timeline items={cvData.experience.map((e: any) => ({
        title: e.title,
        subtitle: e.organization,
        date: `${e.start_date} â€” ${e.end_date}`,
        description: e.description,
      }))} />
    </section>
  )}

  <!-- Awards -->
  {cvData.awards?.length > 0 && (
    <section class="mb-12 animate-on-scroll">
      <h2 class="text-xl font-semibold mb-6 flex items-center gap-2">
        <svg class="w-5 h-5 text-[var(--color-accent)]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"/></svg>
        Awards &amp; Honors
      </h2>
      <div class="space-y-3">
        {cvData.awards.map((award: any) => (
          <div class="flex items-start gap-4 p-3 rounded-lg hover:bg-[var(--color-border)]/30 transition-colors">
            <span class="text-sm font-mono text-[var(--color-text-secondary)] shrink-0 min-w-[3rem]">{award.year}</span>
            <div>
              <p class="font-medium">{award.title}</p>
              <p class="text-sm text-[var(--color-text-secondary)]">{award.organization}</p>
            </div>
          </div>
        ))}
      </div>
    </section>
  )}

  <!-- Service -->
  {cvData.service?.length > 0 && (
    <section class="mb-12 animate-on-scroll">
      <h2 class="text-xl font-semibold mb-6 flex items-center gap-2">
        <svg class="w-5 h-5 text-[var(--color-accent)]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
        Professional Service
      </h2>
      <div class="space-y-3">
        {cvData.service.map((s: any) => (
          <div class="flex items-start gap-4 p-3 rounded-lg hover:bg-[var(--color-border)]/30 transition-colors">
            <span class="text-sm font-mono text-[var(--color-text-secondary)] shrink-0 min-w-[6rem]">{s.years}</span>
            <div>
              <p class="font-medium">{s.role}</p>
              <p class="text-sm text-[var(--color-text-secondary)]">{s.organization}</p>
            </div>
          </div>
        ))}
      </div>
    </section>
  )}
</BaseLayout>

<style>
  @media print {
    nav, footer, .download-btn { display: none !important; }
    body { background: white; color: black; font-size: 11pt; }
    main { max-width: 100%; padding: 0; }
    section { page-break-inside: avoid; }
  }
</style>
