---
import VenueBadge from './VenueBadge.astro';
import type { Publication } from '@lib/types';

interface Props {
  pub: Publication;
  authorName: string;
}

const { pub, authorName } = Astro.props;

function formatAuthors(authors: string[], name: string): string {
  const parts = name.trim().split(/\s+/);
  const firstName = parts[0] || '';
  const lastName = parts[parts.length - 1] || '';
  return authors.map(a => {
    const aParts = a.trim().split(/\s+/);
    const aFirst = aParts[0] || '';
    const aLast = aParts[aParts.length - 1] || '';
    const lastMatch = aLast === lastName;
    const firstMatch = aFirst === firstName || (aFirst.length <= 2 && aFirst[0] === firstName[0]);
    return (lastMatch && firstMatch) ? `<strong class="text-[var(--color-text)]">${a}</strong>` : a;
  }).join(', ');
}
---

<div
  class="p-4 sm:p-5 rounded-xl bg-[var(--color-card-bg)] border border-[var(--color-border)] border-l-2 border-l-[var(--color-accent)]/30 card-hover"
  data-pub-card
  data-venue-type={pub.venueType}
  data-title={pub.title}
  data-authors={pub.authors.join(', ')}
  data-venue={pub.venue}
>
  <div class="flex items-start gap-4">
    <div class="flex-1 min-w-0">
      <h3 class="font-medium leading-snug text-[var(--color-text)]">
        {pub.pdf || pub.url ? (
          <a href={pub.pdf || pub.url} target="_blank" rel="noopener noreferrer" class="hover:text-[var(--color-accent)] transition-colors">
            {pub.title}
          </a>
        ) : pub.title}
      </h3>

      <p class="mt-1.5 text-sm text-[var(--color-text-secondary)]" set:html={formatAuthors(pub.authors, authorName)} />

      <div class="mt-2 flex flex-wrap items-center gap-2">
        <VenueBadge type={pub.venueType} />
        <span class="text-sm text-[var(--color-text-secondary)]">{pub.venue}</span>
      </div>

      <!-- Action links -->
      <div class="mt-3 flex flex-wrap gap-2">
        {pub.pdf && (
          <a href={pub.pdf} target="_blank" rel="noopener noreferrer" class="inline-flex items-center gap-1 px-2.5 py-1 rounded-lg text-xs font-medium bg-[var(--color-border)]/50 hover:bg-[var(--color-accent)]/10 hover:text-[var(--color-accent)] transition-colors">
            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
            PDF
          </a>
        )}
        {pub.code && (
          <a href={pub.code} target="_blank" rel="noopener noreferrer" class="inline-flex items-center gap-1 px-2.5 py-1 rounded-lg text-xs font-medium bg-[var(--color-border)]/50 hover:bg-[var(--color-accent)]/10 hover:text-[var(--color-accent)] transition-colors">
            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"/></svg>
            Code
          </a>
        )}
        {pub.video && (
          <a href={pub.video} target="_blank" rel="noopener noreferrer" class="inline-flex items-center gap-1 px-2.5 py-1 rounded-lg text-xs font-medium bg-[var(--color-border)]/50 hover:bg-[var(--color-accent)]/10 hover:text-[var(--color-accent)] transition-colors">
            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
            Video
          </a>
        )}
        {pub.slides && (
          <a href={pub.slides} target="_blank" rel="noopener noreferrer" class="inline-flex items-center gap-1 px-2.5 py-1 rounded-lg text-xs font-medium bg-[var(--color-border)]/50 hover:bg-[var(--color-accent)]/10 hover:text-[var(--color-accent)] transition-colors">
            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg>
            Slides
          </a>
        )}
        {pub.doi && (
          <a href={`https://doi.org/${pub.doi}`} target="_blank" rel="noopener noreferrer" class="inline-flex items-center gap-1 px-2.5 py-1 rounded-lg text-xs font-medium bg-[var(--color-border)]/50 hover:bg-[var(--color-accent)]/10 hover:text-[var(--color-accent)] transition-colors">
            DOI
          </a>
        )}
      </div>
    </div>
    {pub.preview && (
      <a href={`/images/publications/${pub.preview}`} target="_blank" rel="noopener noreferrer" class="hidden sm:block shrink-0" data-lightbox>
        <img
          src={`/images/publications/${pub.preview}`}
          alt=""
          class="w-24 h-24 md:w-28 md:h-28 rounded-lg object-contain shrink-0 border border-[var(--color-border)] bg-[var(--color-bg)] p-1"
          loading="lazy"
        />
      </a>
    )}
  </div>
</div>
